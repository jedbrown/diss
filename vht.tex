We consider the problem of computing a steady-state energy (in the form of temperature, moisture, and kinetic energy) field coupled to a Stokes problem with rheology depending on strain rate, pressure, temperature, and melt fraction.
This problem is most important as part of inversion for a temperature field that is compatible with the observed geometry, flow field, borehole temperature measurements, and any other field observations.
Time-stepping a transient model to steady state is extremely expensive, therefore it will never be feasible as part of the functional to be minimized by an optimization algorithm.
The implicit method used for the steady-state prbolem can also be used to solve the transient system with time steps of arbitrary length, with no CFL stability limitation.
The transient system produces algebraic systems that are somewhat easier to solve numerically.

\subsection{Problem description}\label{ssec:vhtproblem}
Given a Lipschitz domain $\Omega$ with surface $\Gamma_s$ and time interval $(0,\tau)$, the strong form is to find total momentum, pressure, and total energy density $(\rho\uu,p,E) \in W^{1,\pfrak} \times L^2 \times H^1$ such that
\begin{subequations}\label{eq:vhtstrong}
  \begin{align}
    (\rho\uu)_t + \div (\rho\uu\otimes\uu - \eta D\uu_i + p\bm 1) - \rho \bm g &= 0 \label{eq:vhtstrong:momentum} \\
    \rho_t + \div \rho\uu &= 0 \label{eq:vhtstrong:mass} \\
    E_t + \div \left((E+p)\uu - k_T\nabla T - L (1-\omega)\frac{\rho_i}{\rho}\kappa_\omega\nabla\omega \right) - \eta D\uu_i\tcolon D\uu_i - \rho\uu\cdot\bm g &= 0 \label{eq:vhtstrong:energy}
  \end{align}
\end{subequations}
on $\Omega\otimes (0,\tau)$, with Dirichlet flow boundary conditions except at the free surface, and all Dirichlet boundary conditions for energy $E$.
These equations represent conservation of momentum, mass, and energy respectively.
Note that $\rho_t$ appears in \eqref{eq:vhtstrong:mass}, but $\rho$ is not an explicit variable and only depends on pressure when the melt fraction is positive, therefore this system is still differential algebraic.
The energy equation consists of a transport term, thermal diffusion, moisture diffusion, and heat production due to strain heating.
We switch immediately to the steady-state form of \eqref{eq:vhtstrong} in which $(\rho\uu)_t$, $\rho_t$, and $E_t$ are all zero.
Constitutive relations are needed for total density $\rho$ (\si{\kilogram\per\metre}), ice velocity $\uu_i$ (\si{\metre\per\second}), temperature $T$ (\si{\kelvin}), volumetric moisture fraction (porosity) $\omega$ (nondimensional), and viscosity $\eta$ ($\si{\pascal\second} = \si{\kilogram\per\metre\per\second}$).
In general, each constitutive relation is a function of all field variables.
The thermal conductivity $k_T$ (\si{\joule\per\metre\per\kelvin\per\second}) and hydraulic diffusivity $\kappa_\omega$ (\si{\kilogram\metre\per\second}) are taken to be constant because experimental data are sparse, but this assumption is in no way critical.

The constitutive relations for temperature and moisture fraction are usually defined piecewise.
It is preferable for the convergence of Newton methods~\citep[\cf][]{gropp2000globalized,kelley1995iterative} to have a discretization with $C^1$ continuity and it is simpler for manufactured solutions if the constitutive relation has a global (\ie not piecewise) definition in terms of analytic functions.
To achieve this, we decompose the function $\mathcal{S}(x) = x$ into two globally smooth parts
\begin{equation}\label{eq:vhttransition}
  \begin{split}
    % \mathcal S_\delta^-(x) &= \frac{x}{2} \left(1 - \erf \frac{x}{\sqrt 2 a} \right)  -\frac{a}{\sqrt{2\pi}} \exp{\frac{-x^{2}}{2 a^{2}}} \\
    % \mathcal S_\delta^+(x) &= \frac{x}{2} \left(1 + \erf \frac{x}{\sqrt 2 a} \right) + \frac{a}{\sqrt{2\pi}} \exp{\frac{-x^{2}}{2 a^{2}}} \\
    \mathcal S_\delta^-(x) &= \frac{x}{2} - \frac{x}{2} \erf \frac{x}{\sqrt 2 \delta} - \frac{\delta}{\sqrt{2\pi}} \exp{\frac{-x^{2}}{2 \delta^{2}}} \\
    \mathcal S_\delta^+(x) &= \frac{x}{2} + \frac{x}{2} \erf \frac{x}{\sqrt 2 \delta} + \frac{\delta}{\sqrt{2\pi}} \exp{\frac{-x^{2}}{2 \delta^{2}}}
  \end{split}
\end{equation}
which satisfy $\mathcal S_\delta^- (x) < 0$, $\mathcal S_\delta^+(x) > 0$ and $\mathcal S_\delta^-(x) + S_\delta^+(x) = x$.
These functions arise from integrating the error function with standard deviation $\delta$.
Taking $\delta\to 0$ recovers the piecewise linear decomposition $\mathcal S_0^-(x) = \min(x,0)$, $\mathcal S_0^+(x) = \max(x,0)$.
In applications where a single global function is not important, the decomposition $\mathcal S^\pm$ could be defined using a spline which would reduce the high computational cost of evaluating $\erf$.
This decomposition will be used to separate internal energy into thermal and melt contributions.

For convenience in defining constitutive relations, we introduce specific internal energy $e$ (\si{\joule\per\kilogram}) which is related to total and kinetic energy through
\begin{equation*}
  E = \rho e + \half (1-\omega) \rho_i \abs{\uu_i}^2 + \half \omega \rho_w \abs{\uu_w}^2
\end{equation*}
which we approximate as
\begin{equation}\label{eq:intenergy}
  E = \rho e +  \frac{1}{2\rho} \abs{\rho\uu}^2 .
\end{equation}
This approximation may be violated, for example, at moderate porosity when the velocity of the melt fraction is very high compared to the bulk velocity, such as in an actively draining moulin.
In such circumstances, it is likely unavoidable to add additional variables for water momentum and energy.
Consistent with exact incompressibility, the internal energy is independent of pressure even though observable quantities like temperature and moisture fraction are dependent on pressure.
Removing this assumption would produce acoustic waves and a conservative formulation would require that density be an explicit degree of freedom.
When combined with the closure for $\rho(p,e)$, shown below, \eqref{eq:intenergy} requires solving an implicit equation involving the decomposition $\mathcal S^\pm$.
This implicit equation can always be reduced to one dimension and can be solved explicitly for some definitions of $\mathcal S^\pm$.
For some purposes, it is acceptable to simply take $\rho \approx \rho_i$.
%, therefore we use the density of pure ice $\rho \approx \rho_i$ and the ice velocity $\uu_i = \uu$ (valid for $\omega \ll 1$) in this equaiton \emph{only}.
The convective contributions to momentum balance $\rho\uu\otimes\uu$ and kinetic energy $\frac{1}{2\rho}\abs{\rho\uu}^2$ have vanishing influence in glaciology, but are easy to accommodate so we keep them for completeness.
An alternative would be to discretize using $\rho$ instead of $p$ as the independent variable, but near incompressibility and the variation due to moisture content causes the resulting system to be extremely ill-conditioned.

The closures for \eqref{eq:vhtstrong} are
\begin{subequations}\label{eq:vhtclosure}
  \begin{align}
    \rho(p,e)        & = \big(1-\omega(p,e) \big) \rho_i + \omega(p,e) \rho_w                            \\
    \uu_i(\uu,p,e)   & = \uu + \rho(p,e)^{-1} \kappa_\omega \nabla\omega(p,e) \label{eq:vhtclosure:uice} \\
    T(p,e)           & = T_0 + \frac{e_m(p) + \mathcal S_\delta^-\big(e - e_m(p)\big)}{c_i} \\
    \omega(p,e)      & = \frac{\rho_i \mathcal S_\delta^+\big(e - e_m(p)\big)}{\rho_w L - (\rho_w-\rho_i)\mathcal S_\delta^+\big(e - e_m(p)\big)} \\
    \eta(\gamma,p,e) & = B(p,e)\left(\epsilon^2 + \frac{\gamma}{\gamma_0} \right)^{\frac{\mathfrak{p}-2}{2}}
  \end{align}
\end{subequations}
with second invariant $\gamma = \half D\uu\tcolon D\uu$ and the additional constitutive relations
\begin{align*}
  T_m(p)   & = T_3 - \beta_{CC} p          \\
  e_m(p)   & = c_i \big(T_m(p) - T_0 \big) \\
  T^*(p,e) & = T(p,e) - T_m(p) + T_3       \\
  B(p,E)   & = B_0 \exp \left( \frac{Q - pV}{\nfrak R T^*(p,e)} - \frac{Q}{\nfrak R T_0} \right) \big(1 + B_\omega \omega(p,E) \big)^{-1/\nfrak}
\end{align*}
with physical constants given in \tabref{tab:vhtconst}.
Since dimensional units are used here unlike in earlier sections, the strain rate regularization $\epsilon$ is now a fraction of $\gamma_0$ which is the second invariant of a reference strain rate.
The Arrhenius relation is normalized to zero pressure and a reference temperature $T_0$.
This formulation is not conventional in glaciology, but permits more intuitive understanding of parameters because they are no longer sensitive to the power law exponent $\pfrak$ and large exponential terms.

\begin{table}
  \centering
  \begin{tabular}{clll}
    \toprule
    Symbol          & Value                                         & Description                                                       \\
    \midrule
    $c_i$           & \SI{2009}{\joule\per\kilogram\per\kelvin}     & Specific heat capacity of ice                                     \\
    %$c_w$          & \SI{4170}{\joule\per\kilogram\per\kelvin}     & Specific heat capacity of water                                   \\
    $k_T$           & \SI{2.1}{\watt\per\metre\per\kelvin}          & Thermal conductivity of ice                                       \\
    $\rho_i$        & \SI{910}{\kilogram\per\metre\cubed}           & Density of ice                                                    \\
    $\rho_w$        & \SI{1000}{\kilogram\per\metre\cubed}          & Density of liquid water                                           \\
    $L$             & \SI{3.34e5}{\joule\per\kilogram}              & Latent heat of fusion                                             \\
    $g$             & \SI{9.81}{\metre\per\second\squared}          & Gravitational acceleration                                        \\
    $\kappa_\omega$ & \SI{1.045e-4}{\kilogram\per\metre\per\second} & Hydraulic diffusivity of ice                                      \\
    %$K_w$          & \SI{1.045e-4}{\kilogram\per\metre\per\second} & Temperature ice diffusivity
    $\beta_{CC}$    & \SI{7.9e-8}{\kelvin\per\pascal}               & Clausius-Capeyron gradient                                        \\
    $T_3$           & \SI{273.15}{\kelvin}                          & Triple point of water                                             \\
    $T_0$           & \SI{260}{\kelvin}                             & Reference temperature                          \\
    $\gamma_0$      & $\half (\SI{1e-10}{\per\second})^2$           & Second invariant of reference strain rate                         \\
    $B_0$           & \SI{8.56e14}{\pascal\second}                  & Viscosity at reference strain rate and temperature                \\
    $Q$             & \SI{6.0e4}{\joule\per\mole}                   & Activation energy for creep                                       \\
    $V$             & \SI{-13.e-6}{\metre\cubed\per\mole}           & Activation volume for creep                                       \\
    $R$             & \SI{8.31441}{\joule\per\mole\per\kelvin}      & Ideal gas constant                                                \\
    $B_\omega$      & 181.25                                        & Influence of water content on viscosity \citep{greve2009dynamics} \\
    \bottomrule
  \end{tabular}
  \caption{Physical constants used for the viscous heat transport problem.
    The same constants are used in \citet{aschwanden2011enthalpy}.}\label{tab:vhtconst}
\end{table}

The definitions of the moisture flux in \eqref{eq:vhtstrong:energy} and ice velocity $\uu_i$ require further explanation.
The total momentum can be defined in terms of constituent momenta as
\begin{equation}\label{eq:wmomentum}
  \begin{split}
    \rho\uu & = (1-\omega) \rho_i \uu_i + \omega \rho_w \uu_w                             \\
            & = (1-\omega) \rho_i \uu_i + \omega \rho_w \uu_i + \omega\rho_w(\uu_w - \uu_i) \\
            & = \rho \uu_i + \omega\rho_w(\uu_w - \uu_i) .
  \end{split}
\end{equation}
The second term is the momentum of the moisture content in the reference frame of the ice.
The mass flux of the moisture is $-\kappa_\omega\nabla\omega$ which is also the momentum density.
That is, the integral of $-\kappa_\omega\nabla\omega$ over a surface element is the mass flux (\si{\kilogram\per\second}) through that surface, while the integral over a volume element is the momentum (\si{\kilogram\metre\per\second}) of that volume.
Substituting $\omega\rho_w(\uu_w - \uu_i) = -\kappa_\omega\nabla\omega$ into \eqref{eq:wmomentum} and solving for $\uu_i$ yields
\begin{equation*}
  \uu_i = \uu + \rho^{-1} \kappa_\omega \nabla\omega
\end{equation*}
as in \eqref{eq:vhtclosure:uice}.
In \eqref{eq:vhtstrong:energy}, we need the energy flux in the reference frame of the total velocity.
Starting from the mass flux in the reference frame of total velocity,
\begin{equation}\label{eq:vhtmomflux}
  \begin{split}
    \omega\rho_w(\uu_w - \uu) & = \omega \rho_w (\uu_w - \uu_i) + \omega\rho_w(\uu_i - \uu)                             \\
                              & = -\kappa_\omega\nabla\omega + \frac{\omega\rho_\omega}{\rho}\kappa_\omega\nabla \omega \\
                              & = - \left( 1 - \frac{\omega\rho_\omega}{\rho} \right) \kappa_\omega \nabla \omega \\
                              & = - (1-\omega)\frac{\rho_i}{\rho}\kappa_\omega\nabla\omega
  \end{split}
\end{equation}
where the moisture flux and \eqref{eq:vhtclosure:uice} was used on the second line.
The mass flux in \eqref{eq:vhtmomflux} is converted to energy flux by multiplying by the latent heat $L$ to produce the moisture flux appearing in \eqref{eq:vhtstrong:energy}.
The use of constant hydraulic conductivity $\kappa_\omega$ is a poor approximation for large amplitude $\omega$ since intraglacial conduits form for higher melt fractions, thus conductivity becomes nearly infinite.
For such cases, it would likely be better to use a Darcy-type constitutive relation accommodating the gravitational contribution and with conductivity dependent on moisture, perhaps of the form $\kappa(\omega) = \kappa_0 \exp \frac{\omega}{\omega_0}$ where $\kappa_0$ is the conductivity for vanishing moisture fraction and $\omega_0$ is a characteristic melt fraction on the order of \SI{1}{\percent}.

The volumetric flux $p\bm u$ appearing in \eqref{eq:vhtstrong:energy} could have been written as part of a single heating term.
For single-phase compressible flows, the heat production can be written $(\eta D\uu - p\bm 1)\tcolon \grad \uu$ from classical definitions of work~\citep[\eg][]{hutter2004continuum}, plus a kinetic energy contribution $-\uu\cdot\nabla p$.
These can be manipulated as
\begin{equation}\label{eq:heatdiss}
  \begin{split}
    (\eta D\uu - p\bm 1)\tcolon \grad \uu - \uu\cdot\grad p &= \eta D\uu\tcolon \grad\uu - p\div\uu - \uu\cdot\grad p \\
    &= \eta D\uu\tcolon D\uu - \div (p\uu)
  \end{split}
\end{equation}
which is the form appearing in \eqref{eq:vhtstrong:energy}.
Although both expressions are equivalent for the continuous equations, the discrete equations are different because numerical solutions only satisfy partial differential equations weakly.
Only the latter formulation is conservative.
This formulation is also more amenable to discretization and is mandatory for stability when density is dependent on pressure (as it is here when melt content is available, though the underlying physical process still does not support acoustics) and diffusion is poorly resolved on the mesh.
The first term in \eqref{eq:heatdiss} is non-reversible dissipation while the second can be recovered through volume change and thus does not affect the global entropy.
The ice velocity $\uu_i$ is used in \eqref{eq:vhtstrong:energy} because the melt fraction is assumed to be able to move through the ice matrix without viscous dissipation.
Perhaps this is a reasonable assumption because the viscosity of ice is \num{1e15} times larger than water, but for relatively stagnant ice with high moisture velocity, it is likely to be significant and the equations can be augmented with an additional diffusive term.

The present formulation is similar to \citet{aschwanden2011enthalpy} and approaches their model in the limit $\omega\to 0$, but is more conservative.
The formulation here uses a 3D momentum balance and conserves mass, momentum, and energy, regardless of large amplitude moisture content and presence of numerical diffusion.
We have intentionally neglected to write constitutive relations of the form $e(T,\omega,p)$ because such relationships are superfluous for the purpose of solving the equations.
They can be obtained by inverting the constitutive relations presented here and, depending on the experimental setup, may be useful for model validation.

For the purpose of determining cell Peclet numbers (a diagnostic tool and possible input to numerical stabilization methods), it is useful to write the thermal and moisture fluxes using
\begin{align*}
  \frac{\partial T}{\partial E}      & = \frac{\partial T}{\partial e}\frac{\partial e}{\partial E} \approx \frac{1}{c_i} \frac{1}{\rho} \quad\text{Cold ice} \\
  \frac{\partial \omega}{\partial E} & = \frac{\partial \omega}{\partial e}\frac{\partial e}{\partial E} \approx \frac{1}{L} \frac{1}{\rho} \quad\text{Temperate ice}
\end{align*}
so that the diffusive energy flux driven by energy gradient can be written as $-K_T \nabla E - K_\omega \nabla E$ with
\begin{align}\label{eq:vht:ediffusivity}
  K_T      & \approx \frac{k_T}{\rho c_i} = \SI{1.15e-6}{\metre\squared\per\second} \\
  K_\omega & \approx \frac{L \kappa_\omega}{\rho L} = \SI{1.15e-7}{\metre\squared\per\second} .
\end{align}
Note that we have neglected kinetic energy and density dependence in this approximation.
For an element with streamline length $h = \SI{1}{\kilo\metre}$ and velocity $v = \SI{1}{\kilo\metre\per\year}$, the cell Peclet number is $\Peclet_h = hv / K = \num{2.8e4}$ for cold ice and ten times larger for temperate ice.
Numerical methods for such systems require upwinding to prevent non-physical oscillations.
Godunov's Theorem~\citep[1954, see \eg][]{leveque2002finite} states that non-oscillatory linear methods for hyperbolic equations are at most first-order accurate.
Higher order accuracy requires a nonlinear method, even if the equation being solved is linear.
Robust methods for such systems are based on finite volume methods of total variation diminishing (TVD) and total variation bounded (TVB) type, as well as discontinuous Galerkin methods with limiters when necessary~\citep{leveque2002finite,harten1983high,boris1973flux,zalesak1979fully,harten1987uniformly,liu1994weighted,jiang1996efficient,shu2003high,hesthaven2008nodal}.
In comparison, continuous finite element methods are much less robust, and most efforts to stabilize finite element methods for transport-dominated processes have used linear stabilization~\citep{brooks1982sup,hughes1989new,hughes1998variational,matthies2008stabilization}.
Attempts to use nonlinear stabilization with continuous finite element methods have not been very successful.
The best methods, according to the recent comparisons~\citep{john2007spurious,john2008spurious,john2008femtimecdr}, involve extreme restrictions on element types and suffer from difficulty in converging the nonlinear systems~\citep{mizukami1985petrov} or an algebraic construction~\citep{kuzmin2004high} that is difficult to apply with mesh anisotropy and material nonlinearity.
For simplicity, we adopt the streamline upwind Petrov-Galerkin method of \citep{brooks1982sup}, but a discontinuous Galerkin method would be a better choice for discretization of the energy equation on unstructured grids.

An additional detail appears in the finite element discretization of \eqref{eq:vhtstrong}.
The symmetric gradient of ice velocity $D\uu_i$ is needed to define the stress, but only the gradient of momentum
\begin{equation}\label{eq:vhtgradu}
  \begin{split}
    \nabla(\rho\uu) &= \uu \otimes \nabla\rho + \rho \nabla\uu \\
    &= \uu \otimes \nabla\rho + \rho \nabla (\uu_i - \rho^{-1} \kappa_\omega\nabla \omega)
  \end{split}
\end{equation}
is avialable.
Density is not an explict variable in this formulation and the definition of density involves the gradient of the explicit variables, therefore solving for $\nabla\uu_i$ in \eqref{eq:vhtgradu} produces a second order term.
This term can be evaluated using the second derivative of the basis functions or using a local projection, but neither of these methods are conveniently available in {\Dohp} at present, therefore we approximate $\nabla\uu_i$ using
\begin{equation*}
  \nabla(\rho\uu) \approx \uu \otimes \nabla\rho + \rho \nabla \uu_i
\end{equation*}
of \eqref{eq:vhtgradu}.

Although this simulation is run using realistic geometry on a section of the Jakobshavn Isbr{\ae} channel, not all boundary conditions necessary for a realistic simulation have been implemented in {\Dohp}.
More sophisticated lateral boundary conditions, energy conditions, and free-surface evolution are not considered in the present model.
See \citet{aschwanden2011enthalpy} for further discussion of boundary conditions for energy transport.
The output of this simulation is \emph{not} intended as a predictive model, instead it is a demonstration of the capability of the methods to handle systems that were previously not possible or too computationally expensive due to the need for short time steps.

\subsection{Verification}\label{ssec:vhtverif}
To verify the correctness of the implementation, we consider a manufactured solution with rich structure and choose a parameter range to activate all the terms in \eqref{eq:vhtstrong} and constitutive relations.
Instead of the physical parameters in \tabref{tab:vhtconst}, we take all parameters to be of order one, with solid and melt densities of 1 and 2 respectively.
For this problem, the melt fraction rises as high as \SI{28}{\percent} and temperature ranges \SI{11}{\percent} of its absolute value.
Since the activation volume $V$ and Clausius-Capeyron gradient $\beta_{CC}$ are relatively large, the pressure plays a significant, and occasionally dominant role in defining the temperature and the material rheology.
The large moisture content and large density contrast also increase the strength of the nonlinearity.

Due to the non-uniform flow and various constitutive nonlinearities, nondimensional numbers are spatially variable.
The Reynolds number ranges up to about \num{2.4}, the Peclet number ranges up to \num{5.3}, and the Prandtl number ranges from \num{0.6} to 1.
A computed solution, accurate to \SI{0.5}{\percent} is shown in \figref{fig:vhtexact}.
As usual, this manufactured solution is not physically realizable, but it excercises all the terms.

\begin{figure}
  \centering\includegraphics[width=\textwidth]{visit0020}
  \caption{Manufactured solution as computed using a $\Qk 3 - \Qk 2 - \Qk 3$ finite element discretization on a $12\times 12\times 12$ mesh.
    This solution is accurate to 4 digits for momentum and energy, with two digits of accuracy for pressure.
    The gradients are accurate to 3 digits for momentum and energy, with \SI{3}{\percent} error for pressure gradient.}\label{fig:vhtexact}
\end{figure}

We consider norms for a $\Qk 3 - \Qk 2 - \Qk 3$ approximation under $h$-refinement.
Due to the direct appearance of pressure in the equations, we cannot expect to realize fourth order convergence, at least not for the energy equation.
Figure~\ref{fig:vhtrefine} shows the observed convergence behavior in which energy clearly converges with only third order accuracy.
I do not have an explanation for why the convergence for the energy equation eventually stagnates.
It could be an artifact of the manufactured solution process (perhaps rectifiable using more accurate quadrature for the forcing term), other quadrature errors due to nonlinearity, or stability of the continuum equations or discretization.

\begin{figure}
  \centering\includegraphics{vhtdisc}
  \caption{Convergence rates for $\Qk 3 - \Qk 2 - \Qk 3$ under $h$-refinement.}\label{fig:vhtrefine}
  % ./vhtconvergence.py --plot -o vhtdisc.pdf
\end{figure}

The nonlinear solver converges quadratically as seen in \tabref{tab:vhtsnes}.
All subsequent examples have exhibited similar convergence behavior.
\begin{table}
  \centering
  \begin{tabular}{lllll}
    \toprule
    Iteration & Mass         & Momentum     & Energy       & Total        \\
    \midrule
    0         & 2.142762e-01 & 1.431024e+01 & 2.742861e+01 & 3.093796e+01 \\
    1         & 1.086178e-05 & 8.386431e+00 & 8.412471e+00 & 1.187863e+01 \\
    2         & 2.928430e-06 & 4.103421e+00 & 3.579857e+00 & 5.445497e+00 \\
    3         & 1.744093e-06 & 3.059956e+00 & 6.853340e-01 & 3.135764e+00 \\
    4         & 8.688964e-07 & 1.891518e+00 & 2.980380e-01 & 1.914854e+00 \\
    5         & 4.952597e-07 & 6.852763e-01 & 7.214378e-02 & 6.890634e-01 \\
    6         & 1.430063e-07 & 4.827890e-02 & 6.381075e-03 & 4.869877e-02 \\
    7         & 1.057706e-08 & 3.257086e-05 & 3.007905e-05 & 4.433521e-05 \\
    8         & 1.759267e-11 & 4.249319e-10 & 1.387815e-10 & 4.473666e-10 \\
    \bottomrule
  \end{tabular}
  \caption{Nonlinear convergence rates.}\label{tab:vhtsnes}
\end{table}

Numerical experiments with nonlinear solver convergence and pseudo-transient continuation~\citep{coffey2003ptc,kelley1998cap} indicates that this system does not always have steady-state solutions, and when steady-state solutions exist, they may be non-unique.
It would be interesting to explore these uniqueness properties using bifurcation techniques such as those in \citet{allgower2003inc}.
However, these phenomena have not been observed in parameter ranges that are realistic for ice flow, so we do not explore them further.
Note that such nonlinear effects do occur in glaciology, but generally involve sliding and/or geometry change.
With thermally-induced density variation, gravity, and a boundary heat source, there are not steady-states above a critical Rayleigh number.
This is seen in mantle convection and other fields, for which \eqref{eq:vhtstrong} is also valid, therefore it is no surprise that steady-states are not present.

For Dirichlet problems, pressure is only determined up to a constant.
As far as the solver is concerned, this is easy to handle by applying the Krylov iteration with null space removed and using a preconditioner that is tolerant of the one dimensional null space.
Most preconditioners other than direct solvers are suitable, and the methods of \secref{sec:multiphysics:fieldsplit} perform fine as long as inner solvers (if used) are also informed of the null space.
However, unlike for linear and power-law Stokes problems, the absolute value of pressure affects the other variables.
Thus there is a one-parameter family of solutions in which all variables change rather than only the pressure.
Additionally, it is possible to compute a negative pressure during the nonlinear solve.
This is most common at higher viscosity because the forcing terms in the manufactured solutions become huge, thus producing extreme values of pressure.
Negative pressures produce feedback through the activation volume $V$ to generate exponentially large viscosity.

\subsection{A simple problem}\label{sec:vhtsimple}
To help understand the equations, we consider a block of size $[0,1]^3$ resting on a plate inclined at \SI{30}{\degree}.
The block flows under its own weight with density variation due to moisture content.
No-slip boundary conditions are imposed at the bottom, the sides and surface are free.
This problem is nondimensional with densities of 1 and 2 for ``ice'' and ``water'' respectively.
The conductivities are $\kappa_\omega = \num{2e-2}$ and $k_T = \num{4e-2}$ which produces a Peclet number of 120.
Streamline stabilization similar to SUPG~\citep{brooks1982sup} was used (SUPG does not apply directly to this sort of problem).
The power law exponent is $\pfrak=1.5$ with reference viscosity $B_0 = 5$, leading to a Reynolds number of \num{0.24}.
Dirichlet energy boundary conditions $E(x,y,z) = -x (1-y^2)$ are used, where energy is measured relative to $T_0 = T_3 = 10$ at zero pressure.
The latent heat of fusion is $L=10$ which produces a maximum moisture fraction of \SI{15}{\percent}.

The computed energy and flow fields are shown in \figref{fig:vhtblock:energy} with the corresponding viscous dissipation $\eta D\uu\tcolon D\uu$ in \figref{fig:vhtblock:sigma}.
Note that these steady states are not realizable because this configuration does not have steady solutions.

\begin{figure}
  \centering\includegraphics[width=\textwidth]{visit0031}
  \caption{Energy isosurfaces and velocity streamlines for the block on an inclined plate.
  The phase transition surface occurs roughly at the $E=0$.}\label{fig:vhtblock:energy}
\end{figure}

\begin{figure}
  \centering\includegraphics[width=\textwidth]{visit0030}
  \caption{Viscous heat production $\eta D\uu_i\tcolon D\uu_i$ isosurfaces and velocity streamlines for the block on an inclined plate.}\label{fig:vhtblock:sigma}
\end{figure}

Streamline diffusion such as SUPG is not a robust stabilization for this problem and it breaks down for this problem when the Peclet number exceeds about 200.
This seems to be due to the localized shear region near the downstream corner with high viscous dissipation.
The velocity in this region is very small, so the streamline diffusion proportional to $\abs{\uu} h$ \footnote{%
More precisely, the streamline diffusion is proportional to velocity times the length of the cell in the streamline direction, which can be computed using the transform from the reference coordinates as $\abs{\grad_X \bm x \cdot \uu}$.
} is small, but there are still sharp gradients.
There is a $1/r$ singularity in the viscous heat production term $\eta D\uu_i\tcolon D\uu_i$, as discussed in \secref{sec:regularity:singular}.
The precise mechanism for numerical instability with low diffusivity at the corner that SUPG appears unable to stabilize has not been identified, but it is less pronounced when the angle of incline is reduced.
It is conceivable that a steady state solution to the continuum problem no longer exists.

\subsection{Scaling}\label{sec:vhtscaling}
For the purpose of improving the conditioning for numerical stability and iterative solvers, it is desirable that all field variables assume values of similar size and that the residuals also have similar size.
Since we can choose the overall norm of the system arbitrarily, we choose to make field variables and residuals both of order 1.
For the field variables, we choose characteristic sizes for the independent variables $\rho\uu$, $p$, and $E$.
These are just meant to identify the order of magnitude so we choose powers of ten for simplicity.
We would like the following characteristic quantities to have nondimensional size 1.
\begin{equation}\label{eq:vhtsizes}
  \begin{split}
    [\rho\uu] &= \SI{1e3}{\kilo\gram\per\metre\cubed} \, \SI{1e-4}{\metre\per\second} = \SI{1e-1}{\kilo\gram\per\metre\squared\per\second} \\
    [p] &= \rho \abs{\bm g} \, \SI{1e3}{\metre} = \SI{1e7}{\pascal} = \SI{1e7}{\kilo\gram\per\metre\per\second\squared} \\
    [E] &= \rho c_i \, \SI{5}{\kelvin} = \SI{1e7}{\joule\per\metre\cubed} = \SI{1e7}{\kilo\gram\per\metre\per\second\squared} \\
  \end{split}
\end{equation}
This is degenerate because energy density and pressure have the same units, therefore we can ask for one further constraint.
We choose to make a viscous stress of \SI{100}{\kilo\pascal} integrated over an area of \SI{1}{\kilo\metre\squared} have nondimensional size 1 which ensures that the viscous part of the momentum residual will be of order 1.
Asking for momentum, pressure, and viscous flux over a characteristic area to be of order unity amounts to solving
\begin{align*}
  \SI{.1}{\kilogram\per\metre\squared\per\second} &= 1 \\
  \SI{1e7}{\kilo\gram\per\metre\per\second\squared} &= 1 \\
  \SI{1e11}{\kilo\gram\metre\per\second\squared} &= 1
\end{align*}
which has the unique solution
\begin{align}\label{eq:vhtunits}
  \si{\kilo\gram} &= \num{1e3} & \si{\metre} &= \num{1e-2} & \si{\second} &= \num{1e6} .
\end{align}
In other words, the characteristic scales are \SI{1}{\gram}, \SI{100}{\metre}, and \SI{1}{\micro\second}.
Due to the Lagrange-multiplier coupling of the pressure, this also ensures that the pressure is well-behaved relative to the velocity.
Independently changing the scaling for the mass continuity equation would cause the Stokes problem to be non-symmetric.
The energy equation, however, is very poorly scaled by this choice.
For example, the advective energy flux $[E][u]$ integrated over an are of size \SI{1}{\kilo\metre\squared} has size
\begin{equation*}
  (\SI{1e6}{\metre\squared}) (\SI{1e7}{\kilo\gram\per\metre\per\second\squared}) (\SI{1e-4}{\metre\per\second}) = \SI{1e9}{\kilo\gram\metre\squared\per\second\cubed} = \num{1e-10} .
\end{equation*}
We scale the energy equation by \num{1e10} to correct this.
With nondimensionalization defined by \eqref{eq:vhtunits}, all solution variables have order unity and the unconverged residuals (after balancing the hydrostatic mode which is about 100 times larger) also have the same order.
As a consequence, the Jacobian has norm of order unity in the subspace where the hydrostatic mode is balanced.

\subsection{Numerical solution}\label{sec:vhtalgebraic}
As discussed above and in \secref{sec:regularity}, the equation system \eqref{eq:vhtstrong} must be interpreted weakly because the fields have insufficient regularity.
Dropping the transient terms, the weak form is: find $(\rho\uu,p,E) \in W^{1,\pfrak}_D \times L^2 \times H^1_D$ such that
\begin{multline}\label{eq:vhtweak}
  \int_\Omega \bigg[
    \nabla\tf\mm \tcolon ( -\rho\uu\otimes\uu + \eta D\uu_i) - p\div\tf\mm - \rho \tf\mm\cdot \bm g -\tf p \div \rho\uu \\
    + \nabla\tf E \cdot \Big(
      -(E+p)\uu + k_T\nabla T + L (1-\omega)\frac{\rho_i}{\rho}\kappa_\omega\nabla\omega
    \Big) - \tf E \left( \eta D\uu_i\tcolon D\uu_i - \rho\uu\cdot\bm g \right)
    \bigg] = 0
\end{multline}
for all momentum, mass, and energy test functions $(\tf\mm,\tf p,\tf E) \in W^{1,\pfrak}_0 \times L^2 \times H^1_0$.
The trial spaces $W^{1,\pfrak}_D$ and $\times H^1_D$ have inhomogeneous Dirichlet boundary conditions built in on $\partial\Omega\setminus \Gamma_s$ and $\partial\Omega$ respectively, where $\Gamma_s$ is the free surface.
The corresponding test spaces have homogeneous boundary conditions built in.
We assume that the free surface $\Gamma_s \subset \partial\Omega$ is non-empty, therefore the pressure trial space and corresponding mass test space do not need a constraint.

The finite element method solves \eqref{eq:vhtweak} by introducing discrete test and trial spaces as well as a method of numerical integration.
The numerical examples in this section use $\Qk 3 - \Qk 2 - \Qk 3$, but other choices are possible.
In the present implementation, the order of each approximation space can be chosen independently through run-time options.
Many of the more complicated spaces discussed in \secref{sssec:approximation} are not yet implemented in {\Dohp}, but would automatically become available through run-time options once the library support is added.
Discontinuous $\Pkdisc k$ spaces are not used here because the visualization support is not complete.

Evaluation of the discrete equations and components needed by the solver are implemented using the methods discussed in \secref{sec:dohpuser}.
The discrete residual is evaluated monolithically, by evaluating all fields on a single set of quadrature points and computing the coefficients of the test functions at those points.
For manufactured solutions, the artificial source terms are also evaluated at the quadrature points.
During residual evaluation, certain intermediate quantities including the velocity $\uu$, temperature $T$, and melt fraction $\omega$, as well as the derivatives of these quantities with respect to the independent variables $\rho\uu$, $p$, $E$ and their gradients, are stashed away in quadrature-local storage managed by {\Dohp}.
These stashed values are used to apply the Jacobian and blocks of the Jacobian matrix-free.
The memory and asmyptotic flops benefits of this approach were discussed in \secref{sec:femassembly}.
Computation of the gradients was done by hand, but is an error-prone process that should be automated using reverse-mode automatic differentiation in a highly local manner (a single quadrature point at a time).
An alternative would be to simply store the independent variables and their gradients, then evaluate the action of the Jacobian using forward-mode (automatic or by-hand) differentiation.
The disadvantage of this is that constitutive relations would have to be re-evaluated during Jacobian application.
Since constitutive relations be quite expensive, it is preferable to store some intermediate values.
Another alternative is to store the full Jacobian at each quadrature point.
This would be a nearly dense matrix of size $17\times 20$ (20 comes from the state and gradients of all five fields, three rows are dropped because the gradient of the pressure/mass test function does not appear), or slightly smaller if momentum convection and other symmetry-breaking terms were dropped.
This matrix would be more effort to compute, would require more storage, and would involve more floating point operations to apply than the present method.
On today's hardware, the hybrid method of storing coefficients of specific intermediate quantities is clearly preferable to these alternatives.
However, on some vector hardware, or for other problems with less compact representations, this explicit form could still be desirable.

The Jacobian resulting from Newton linearization of \eqref{eq:vhtweak} has the block structure
\begin{equation}\label{eq:vhtblock}
  J =
  \begin{pmatrix}
    J_{uu} & J_{up} & J_{uE} \\
    J_{pu} & 0 & 0 \\
    J_{Eu} & J_{Ep} & J_{EE}
  \end{pmatrix} .
\end{equation}
The contents of these blocks is summarized below.
\begin{itemize}
  \item[$J_{uu}$] The viscous and (much smaller for ice) momentum convection terms.
    This block is nearly symmetric positive definite and has variable coefficients and anisotropy created by differentiating the power-law constitutive relation.
  \item[$J_{up}$] The weak pressure gradient, viscosity dependence on pressure (directly and through density, temperature, and melt fraction), and the gravitational contribution from pressure-induced density variation (from changing the pressure melting temperature which may change the melt fraction).
    This block is large in magnitude, mostly due to the weak pressure gradient which is nearly balanced by the gravitational forcing source term.
  \item[$J_{uE}$] The viscous dependence on energy (via temperature, melt fraction, and density) as well as the gravitational contribution due to energy-induced density variation.
    This term comes from a highly nonlinear term (the Arrhenius and moisture-dependent constitutive relations) but is typically not especially large in glaciology.
    For bouyancy-driven flows such as mantle convection, the density variation is the crucial driving force for circulation.
    However, despite the crucial coupling provided by this block and it's significant nonlinear influence, it contributes quite little to linear stiffness.
  \item[$J_{pu}$] The divergence of momentum density which inforces mass conservation.
    It is nearly equal to $J_{up}^T$ and is thus also large in magnitude.
    Being the only non-zero block in its row, this is of critical importance.
  \item[$J_{Eu}$] The sensitivity of energy on momentum, which is mostly the advective transport (the gradient of energy divided by density).
    This term is very large in boundary layers containing large thermal and moisture gradients.
    In particular, due to the high Peclet numbers involved, the boundary layers will often never be fully resolved at a practical resolution, thus mesh refinement is capable of resolving ever-larger gradients.
    This results in the size of this term being essentially mesh-dependent.
    This block also contains a similar term involving the pressure gradient, but pressure does not contain the same boundary layers as energy (indeed, the pressure gradient is approximately equal to $\rho \bm g$), so its contribution is much smaller and more benign (provided the pressure discretization is stable so that there are no oscillations).
  \item[$J_{Ep}$] The contribution to thermal and moisture diffusion as well as the advective contribution as a function of pressure gradient.
    Due to the size of perturbations in the pressure gradient, the advective term and the perturbations to the thermal and moisture gradients $\grad T$ and $\grad \omega$ are benign.
    If the transition width $\delta$ in \eqref{eq:vhttransition} is made small, small changes in pressure can move the pressure melting which locally switches from thermal to moisture diffusion.
    According to \eqref{eq:vht:ediffusivity}, this is an order of magnitude change in coefficients, but could be different depending on the constitutive relation for moisture diffusion.
  \item[$J_{EE}$] An advection-diffusion system for energy.
    It is generally advection-dominated except in boundary layers and regions of stagnant ice where diffusion driven by temperature and moisture gradient become significant.
    It is typical that the velocity is almost parallel to the bed in which case vertical diffusion remains significant compared to vertical advection while horizontal (nearly streamline) diffusion is negligible.
    In such cases, the thermal gradients in the horizontal direction are very small.
    There are also advection-like terms arising from differentiating through $S^\pm_\delta$ which appear as transport in the directions $\grad T$ and $\grad \omega$ (usually nearly vertical).
\end{itemize}
All blocks in this system are available in unassembled form, using the reduced storage at quadrature points discussed above.

The discussion above suggests that the blocks $J_{uu}$, $J_{up}$, $J_{pu}$, $J_{Eu}$, and $J_{EE}$ account for most of the linear stiffness, therefore the multiplicative preconditioner
\begin{equation}\label{eq:vht:pcnested}
  P =
  \begin{bmatrix}
    \begin{pmatrix}
      J_{uu} & J_{up} \\
      J_{pu} & 0
    \end{pmatrix} & \\
    J_{Eu} & J_{Ep} & J_{EE}
  \end{bmatrix}
\end{equation}
should be an effective preconditioner for \eqref{eq:vhtblock}.
Indeed, if applied exactly,
\begin{equation*}
  P^{-1}J =
  \begin{bmatrix}
    1 &
    \begin{pmatrix}
      J_{uu} & J_{up} \\ J_{pu} & 
    \end{pmatrix}^{-1}
    \begin{pmatrix}
      J_{uE} \\
    \end{pmatrix} \\
    0 & 1
  \end{bmatrix}
\end{equation*}
which satisfies $(P^{-1}J - 1)^2 = 0$ ensuring that left-preconditioned GMRES converges in two iterations.
Computing
\begin{align*}
  (JP^{-1} - 1)^2 & = JP^{-1}JP^{-1} - 2JP^{-1} + 1           \\
                  & = P(P^{-1}JP^{-1}J - 2P^{-1}J + 1) P^{-1} \\
                  & = P(P^{-1}J - 1)^2P^{-1}                  \\
                  & = (P^{-1}J - 1)^2 = 0
\end{align*}
ensures that right-preconditioned GMRES also converges in two iterations.
Since GMRES convergence is more reliable for matrices that are not too far from normal~\citep{nachtigal1992fnm,embree1999descriptive,trefethen2005spectra} and because we intend to apply $P$ only approximately, it is beneficial that the off-diagonal part of $P^{-1}A$ is relatively small.
This preconditioner can be applied with one (anisotropic variable-coefficient) Stokes solve and one advection-diffusion (variable-coefficient, with anisotropy due to stabilization) solve.

Due to the mechanics of GMRES, three preconditioner applications are required for two iterations.
By storing more information, the flexible variant FGMRES~\citep{saad1993fgmres} can extract the solution after two right-preconditioned iterations without a third preconditioner application.
The generalized conjugate residual method GCR~\citep{eisenstat1983variational} has the same property and has equivalent convergence properties to GMRES when the preconditioner is linear~\cite{saad1986gmres}.
Both of these methods store two vectors per Krylov iteration which enables them to be tolerant of variable preconditioners.
They both work with the right-preconditioned form, have convergence tests in terms of unpreconditioned residuals, and are commonly restarted to bound the total storage requirement.
FGMRES defines the residual and its norm through a recurrence relation similar to GMRES which has the advantage of requiring less arithmetic per iteration, but means that the residuals are expensive to compute during the iteration, therefore the norm estimated by the algorithm may be unstable.
Classical Gram-Schmidt orthogonalization is not stable, but it is much faster than modified Gram-Schmidt, especially in parallel where reductions are very expensive.
Since GCR computes the norm of the true residual explicitly instead of through a recurrence relation, the CGR convergence test is independent of inaccuracy in the classical Gram-Schmidt process.
GCR with an inexact iterative preconditioner was introduced in \citet{vandervorst1994gmresr} under the name GMRESR and a variant using the same amount of arithmetic per iteration as FGMRES was presented in \citet{vuik1995new}.
See also \citet{brakkee1998domain} for practical comparisons with domain decomposition methods for incompressible flow.

For the Stokes solve in the application of \eqref{eq:vht:pcnested}, we start with the factorization
\begin{equation*}
  \begin{pmatrix}
    J_{uu} & J_{up} \\
    J_{pu} & 
  \end{pmatrix} =
  \begin{pmatrix}
    1 & \\ J_{pu} J_{uu}^{-1}
  \end{pmatrix}
  \begin{pmatrix}
    J_{uu} & J_{up} \\
    & S
  \end{pmatrix}
\end{equation*}
where $S = -J_{pu} J_{uu}^{-1}J_{uu}$.
Since $S$ is dense and will be solved with approximately, it is reasonable to drop the lower-triangular block, leaving
\begin{equation}\label{eq:vht:pcstokes}
  P_s =
  \begin{pmatrix}
    J_{uu} & J_{up} \\
    & S
  \end{pmatrix}
\end{equation}
since the preconditioned operator also has a minimal polynomial of degree 2.

Three assembled matrices are used in the solver defined using approximate solves with \eqref{eq:vht:pcnested,eq:vht:pcstokes}.
The first is $B_{uu}$ which is an approximation of the momentum block $J_{uu}$ assembled using the same physics with truncated basis functions and sub-element $2^3$-point Gauss quadrature.
This matrix corresponds to a $Q_1$ discretization on the sub-elements.
We approximate the inverse of $J_{uu}$ by 10 conjugate gradient iterations preconditioned by block incomplete Cholesky applied to $B_{uu}$.

An approximation of the energy coupling $B_{EE}$ is assembled using the same methodology and the inverse of $J_{EE}$ is computed using GMRES preconditioned by incomplete LU.
This system is converged to a reasonable tolerance of \num{1e-5} because it is relatively inexpensive compared to the Stokes solve.

Approximating the inverse of $S$ and the greater Stokes system is more involved.
Following the results of \citep{olshanskii2006analysis} extrapolated to viscosity variation that is not isotropic or piecewise constant, we approximate $S$ by assembling $B_{pp}$, the mass matrix weighted by the inverse of effective viscosity $\eta$.
The quadrature for this operator in the pressure space is defined using local $2^3$-point Gauss quadratures on the sub-elements associated with the $Q_3$ basis functions.
While this quadrature has a lower order of accuracy than a Gauss quadrature with similar number of points on the whole element, it is more local and more robust to sharp viscosity variation.
It also has the advantage of reusing the same constitutive relation evaluations as the assembled momentum and energy operators.
The inverse of $S$ is approximated using incomplete Cholesky applied to the the scaled mass matrix $B_{pp}$ which has been significantly more robust than the lumped variant in common use~\citep[\eg][]{burstedde2008scalable,may2008pim}.

We converge the Stokes solve to a relative tolerance of \num{1e-3} using GCR with the upper-triangular preconditioner \eqref{eq:vht:pcstokes} where $S$ is replaced by $B_{pp}$ and $J_{uu}$ solved inexactly.
The Eisenstat-Walker~\citet*{eisenstat1996cft} method is used to adjust the linear solve tolerance of the outer Krylov iteration as the Newton iteration converges.
Since the inner solves are relatively accurate and the $J_{uE}$ block has little linear stiffness, this usually converges in one iteration.

A natural alternative preconditioner which was proposed by \citet{elman2011bouyancy} for Picard linearization of 2D isoviscous bouyancy-driven flows with the Boussinesq approximation using $Q_2-Q_1$ elements avoids nested iteration by using
\begin{equation*}
  P_1 =
  \begin{pmatrix}
    J_{uu} & J_{up} & J_{uE} \\
     & B_{pp} & \\
    & & J_{EE} \\
  \end{pmatrix} .
\end{equation*}
Despite several attempts, this preconditioner and many variants were not found to deliver the robustness desired for the present model.
Among other deficiencies, it tended to have very poor behavior under GMRES restarts and often triggered instability in classical Gram-Schmidt.
Since full orthogonalization using modified Gram-Schmidt is not practical, this approach is not used in the present numerical study.
However, through the compositional algebra implemented in {\PETSc}, especially the \cverb|PCFieldSplit| component, all such variants remain available as run-time options.
